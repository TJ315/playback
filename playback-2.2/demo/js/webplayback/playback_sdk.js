var main_url="ccapi.csslcloud.net";!function(){function e(){this.events={}}function t(e){this.userid=e.userid,this.token=e.token,this.sessionid=e.token,this.joinPlayback(e)}e.prototype={on:function(e,t){this.events[e]=this.events[e]||[],this.events[e].push(t)},emit:function(e,t){var i,a,o=this.events[e],r=Array.prototype.slice.call(arguments,1);if(o)for(i=0,a=o.length;i<a;i++)o[i].apply(null,r)},jsonp:function(t){if((t=t||{}).callback=t.callback||"callback",!t.url||!t.callbackName)throw new Error("params is illegal!");t.beforeSend&&t.beforeSend();var i=(t.callbackName+Math.random()).replace(".","");t.data[t.callback]=i;var e=function(e){var t=[];for(var i in e)t.push(encodeURIComponent(i)+"="+encodeURIComponent(e[i]));return t.join("&")}(t.data);window[i]=function(e){a.removeChild(o),clearTimeout(o.timer),window[i]=null,t.success&&t.success(e)};var a=document.getElementsByTagName("head")[0],o=document.createElement("script");a.appendChild(o),o.src=t.url+"?"+e,t.time&&(o.timer=setTimeout(function(){window[i]=null,a.removeChild(o),t.error&&t.error({message:"over time"})},t.time))},ajax:function(t){var e=function(){{if(o("client_id"))return o("client_id");var e=(new Date).getTime().toString().substring(5);return t="client_id",i=e,document.cookie=t+"="+escape(i)+"; expires=Fri, 31 Dec 9999 23:59:59 GMT",e}var t,i}();(t=t||{}).type=(t.type||"GET").toUpperCase(),t.dataType=t.dataType||"json",t.async=t.async||!0;var i,a=function(e){var t=[];for(var i in e)t.push(encodeURIComponent(i)+"="+encodeURIComponent(e[i]));return t.join("&")}(t.data);function o(e){var t,i=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(i))?unescape(t[2]):null}(i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).onreadystatechange=function(){if(4===i.readyState){var e=i.status;200<=e&&e<300?t.success&&t.success(i.responseText,i.responseXML):t.fail&&t.fail(e)}},"GET"===t.type?(i.open("GET",t.url+"?"+a,t.async),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("ClientID",e),this.token&&i.setRequestHeader("token",this.token),i.send(null)):"POST"===t.type&&(i.open("POST",t.url,t.async),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("ClientID",e),i.send(a))}},(t.prototype=new e).joinPlayback=function(i){var a=this;a.roomid=i.roomid,a.liveid=i.liveid,a.recordid=i.recordid;var e={userid:i.userid,isview:1};this.ajax({url:"https://"+main_url+"/api/v1/serve/room/login",type:"GET",data:e,dataType:"json",async:!1,success:function(e){if("FAIL"===(e=JSON.parse(e)).result)a.emit("login_failed",e.errorMsg);else{var t=e.data;a.joinData=i;a.getHistoryPlayBackDraw({userid:a.userid,roomid:a.roomid,liveid:a.liveid});a.video_history_palyback({userid:a.userid,roomid:a.roomid,liveid:a.liveid}),a.insetgetUrl({accountid:a.userid,roomid:a.roomid,liveid:a.liveid}),window.CallbackPlayer=new CallbackPlayer,a.emit("login_success",t)}},fail:function(e){a.emit("login_failed","网络请求失败"),console.log("login_failed",e)}})},t.prototype.joinAudience=function(e){var i=this;if(e)var t={userid:i.userid,isp:e};else t={userid:i.userid};console.log(t,"============================================================="),this.ajax({url:"https://"+main_url+"/api/v1/serve/room/login",type:"GET",data:t,dataType:"json",async:!1,success:function(e){if("FAIL"===(e=JSON.parse(e)).result)throw i.emit("login_failed",e.errorMsg),new Error(e.errorMsg);var t=e.data;i.socket_address=t.chart_server[0],i.socket_spare_address=t.chart_server[1],i.viewerid=t.user.id,i.name=t.user.name,i.roomid=t.user.roomid,i.videoMode=t.video_mode,i.startTime=t.live.startTime?(new Date).getTime():t.live.startTime,i.userRole=t.user.role,i.extUrl=t.rtspurl;t.live.atlas_token;o.user||(i.socket_init(),o.user=!0),i.emit("login_success",t)},fail:function(e){i.emit("login_failed","网络请求失败"),console.log("login_failed",e)}})},t.prototype.join=function(e){if(1===ATLAS.connect)console.log("不能重复登录");else{var a=this;if(e)var t={userid:a.userid,sessionid:a.sessionid,isp:e};else t={userid:a.userid,sessionid:a.sessionid};this.ajax({url:"https://"+main_url+"/api/room/join",type:"POST",data:t,dataType:"json",async:!1,success:function(e){if("FAIL"===(e=JSON.parse(e)).result)a.emit("login_failed",e.errorMsg);else{var t=e.data;a.socket_address=t.chart_server[0],a.socket_spare_address=t.chart_server[1],a.viewerid=t.user.id,a.name=t.user.name,a.roomid=t.user.roomid,a.videoMode=t.video_mode,a.startTime=t.live.startTime?(new Date).getTime():t.live.startTime,a.userRole=t.user.role,a.extUrl=t.rtspurl;var i=t.live.atlas_token;o.user||(a.socket_init(),o.user=!0),ATLAS.reconnect||(ATLAS.init(a),ATLAS.reconnect=!0),r.roomOptions.isFollow=t.is_follow,r.roomOptions.classTpye=t.class_type,r.roomOptions.maxStreams=t.max_streams,r.roomOptions.allowChat=t.allow_chat,r.roomOptions.allowAudio=t.allow_audio,r.roomOptions.allowSpeak=t.allow_speak,r.roomOptions.videoMode=t.video_mode,r.roomOptions.template=t.template,a.emit("login_success",t),"function"==typeof a.ChoicePhoneInit&&a.ChoicePhoneInit(),"function"==typeof a.roomUpdateWatcher&&a.roomUpdateWatcher(),ATLAS.conference.setIceServers([{urls:"stun:turn-cc2.csslcloud.net:80"},{urls:["turn:turn-cc2.csslcloud.net:80?transport=udp","turn:turn-cc2.csslcloud.net:443?transport=udp","turn:turn-cc2.csslcloud.net:80?transport=tcp","turn:turn-cc2.csslcloud.net:443?transport=tcp"],username:"class",credential:"class_2017"}]),a.AtlasJoin(i),a.join_timeout=setTimeout(function(){a.emit("join_timeOut")},1e4)}},fail:function(e){a.emit("login_failed","网络请求失败"),console.log("login_failed",e)}})}},t.prototype.AtlasJoin=function(e){ATLAS.AtlasJoin(this,e)},t.prototype.createLocalStream=function(e){ATLAS.createLocalStream(this,e)},t.prototype.leave=function(){ATLAS.leave(this)},t.prototype.detectExtension=function(e){ATLAS.detectExtension(e,this)},t.prototype.publishShareStream=function(t){var i=this;this.jsonp({url:"https://"+main_url+"/api/live/stat",callbackName:"callback",time:"30000",data:{roomid:i.roomid},success:function(e){"OK"===e.result?!0===e.started?ATLAS.publishShareStream(i,t):(console.log("直播未开始"),"function"===t.fail&&t.fail("直播未开始")):("function"===t.fail&&t.fail(e.errorMsg),console.log(e.errorMsg))},error:function(){console.log("查询直播状态失败，导致没有推桌面共享流"),"function"===t.fail&&t.fail("查询直播状态失败，导致没有推桌面共享流")}})},t.prototype.unPubShareStream=function(){ATLAS.unPubShareStream()},t.prototype.publish=function(t){var i=this;this.jsonp({url:"https://"+main_url+"/api/live/stat",callbackName:"callback",time:"30000",data:{roomid:i.roomid},success:function(e){"OK"===e.result?!0===e.started?ATLAS.publishLocalStream(i,t):(console.log("直播未开始，不能推流"),"function"==typeof t.fail&&t.fail("直播未开始，不能推流")):(console.log(e.errorMsg),"function"==typeof t.fail&&t.fail(e.errorMsg))},error:function(){console.log("查询直播状态失败，导致没有推流"),"function"==typeof t.fail&&t.fail("查询直播状态失败，导致没有推流"),i.emit("local_stream_publish_failed","推流查询直播状态失败，导致没有推流")}})},t.prototype.unPublish=function(e){ATLAS.unPublish(this,e)},t.prototype.trySubscribeStream=function(e){ATLAS.trySubscribeStream(this,e)},t.prototype.unSubscribeStream=function(e){ATLAS.unSubscribeStream(this,e)},t.prototype.pauseVideo=function(e){ATLAS.pauseVideo(e)},t.prototype.playVideo=function(e){ATLAS.playVideo(e)},t.prototype.pauseAudio=function(e){ATLAS.pauseAudio(e)},t.prototype.playAudio=function(e){ATLAS.playAudio(e)},t.prototype.addExternalOutput=function(e){ATLAS.addExternalOutput(this,e)},t.prototype.removeExternal=function(e){ATLAS.removeExternal(this,e)},t.prototype.updateExternalOutput=function(e){ATLAS.updateExternalOutput(e)},t.prototype.setRegion=function(e){ATLAS.setRegion(e)},t.prototype.getRegion=function(e){ATLAS.getRegion(e)},t.prototype.mix=function(e){ATLAS.mix(e)},t.prototype.unMix=function(e){ATLAS.unMix(e)},t.prototype.closeRemoteStreams=function(){ATLAS.closeRemoteStreams()},t.prototype.closeVideo=function(e){ATLAS.closeVideo(e)},t.prototype.getConnectionStats=function(e){ATLAS.getConnectionStats(e)},t.prototype.startRecorder=function(e){ATLAS.startRecorder(e)},t.prototype.stopRecorder=function(e){ATLAS.stopRecorder(e)},t.prototype.publishStreamAdd=function(e){i.publishStreamAdd(this,e)},t.prototype.unPublishStreamRemoved=function(e,t){i.unPublishStreamRemoved(this,e,t)},t.prototype.streamSubscribe=function(e){i.streamSubscribe(this,e)},t.prototype.unStreamSubscribe=function(e){i.unStreamSubscribe(this,e)},t.prototype.getLiveStat=function(e){i.getLiveStat(this,e)},t.prototype.startLive=function(e){i.startLive(this,e)},t.prototype.stopLive=function(e){i.stopLive(this,e)},t.prototype.streamBreak=function(){i.streamBreak(this)},t.prototype.getNetPoint=function(e){i.getNetPoint(e)},t.prototype.getDevice=function(e){a.getDevice(e)},t.prototype.getHistory=function(e){i.getHistory(this,e)},t.prototype.getHistoryPlayBack=function(e){i.getHistoryPlayBack(this,e)},t.prototype.getHistoryPlayBackDraw=function(e){return i.getHistoryPlayBackDraw(this,e)},t.prototype.getHistoryPlayBackChat=function(e){return i.getHistoryPlayBackChat(this,e)},t.prototype.getHistoryPlayBackReplay=function(e){return i.getHistoryPlayBackReplay(this,e)},t.prototype.video_history_palyback=function(e){return i.video_history_palyback(this,e)},t.prototype.insetgetUrl=function(e){return i.insetgetUrl(this,e)},t.prototype.socket_disconnect=function(){o.socket_disconnect()},t.prototype.socket_init=function(){o.init(this)},t.prototype.sendMsg=function(e){o.send(e)},t.prototype.sendImg=function(e){o.media(e)},t.prototype.moveInBlacklist=function(e,t){o.moveInBlacklist(e,t)},t.prototype.moveOutFromAllList=function(e,t){o.moveOutFromAllList(e,t)},t.prototype.kickOut=function(e,t){o.kickOut(e,t)},t.prototype.silenceChat=function(){o.silenceChat()},t.prototype.unSilenceChat=function(){o.unSilenceChat()},t.prototype.flip=function(e){o.flip(e,this)},t.prototype.do_animation=function(e){o.do_animation(e,this)},t.prototype.draw=function(e,t,i){o.draw(e,t,i,this)},t.prototype.videoDraw=function(e,t){o.videoDraw(e,t,this)},t.prototype.startRollcall=function(e,t){o.startRollcall(e,t,this)},t.prototype.answerRollcall=function(e,t){o.answerRollcall(e,t,this)},t.prototype.switchUserSetting=function(e,t,i,a){o.switchUserSetting(e,t,i,a)},t.prototype.warnDown=function(e){o.warnDown(e)},t.prototype.mediaPlayer=function(e){o.mediaPlayer(e)},t.prototype.sendCard=function(e,t,i,a){o.sendCard(e,t,i,a)},t.prototype.stopAnswer=function(e){o.stopAnswer(e)},t.prototype.sendAnswer=function(e,t,i,a){o.sendAnswer(e,t,i,a)};var i={publishStreamAdd:function(e,t,i,a){e.jsonp({url:"https://"+main_url+"/api/atlas/stream/added",callbackName:"callback",time:"30000",data:{roomid:e.roomid,userid:t.attr("userid"),streamid:t.id(),video_bitrate:i,audio_bitrate:a,time:(new Date).getTime()},success:function(e){"OK"===e.result?console.log("ccapi/stream/added","ok"):console.log("ccapi/stream/added",e.errorMsg)}})},unPublishStreamRemoved:function(e,t,i){e.jsonp({url:"https://"+main_url+"/api/atlas/stream/remove",callbackName:"callback",time:"30000",data:{roomid:e.roomid,userid:t,streamid:i,time:(new Date).getTime()},success:function(e){"OK"===e.result?console.log("ccapi/stream/remove","ok"):console.log("ccapi/stream/remove",e.errorMsg)}})},streamSubscribe:function(e,t){e.jsonp({url:"https://"+main_url+"/api/atlas/stream/subscribe",callbackName:"callback",time:"30000",data:{roomid:e.roomid,userid:e.viewerid,streamid:t.id(),time:(new Date).getTime()},success:function(e){"OK"===e.result?console.log("ccapi/stream/subscribe","ok"):console.log("ccapi/stream/subscribe",e.errorMsg)}})},unStreamSubscribe:function(e,t){e.jsonp({url:"https://"+main_url+"/api/atlas/stream/unsubscribe",callbackName:"callback",time:"30000",data:{roomid:e.roomid,userid:e.viewerid,streamid:t.id(),time:(new Date).getTime()},success:function(e){"OK"===e.result?console.log("ccapi/stream/unsubscribe","ok"):console.log("ccapi/stream/unsubscribe",e.errorMsg)}})},getLiveStat:function(e,t){e.jsonp({url:"https://"+main_url+"/api/live/stat",callbackName:"callback",time:"30000",data:{roomid:e.roomid},success:function(e){"OK"===e.result?!0===e.started?(t&&"function"==typeof t.success&&t.success(!0,e),console.log("直播开始状态",e)):(t&&"function"==typeof t.fail&&t.fail("直播关闭状态"),console.log("直播关闭状态",e)):(t&&"function"==typeof t.fail&&t.fail(e.errorMsg),console.log("查询直播出错",e.errorMsg))}})},startLive:function(t,i){t.jsonp({url:"https://"+main_url+"/api/live/start",callbackName:"callback",time:"30000",data:{roomid:t.roomid,userid:t.userid},beforeSend:function(){t.emit("live_before_send")},success:function(e){"OK"===e.result?(t.emit("live_start",e),i&&"function"==typeof i.success&&i.success(e),console.log("成功开始直播")):(t.emit("live_start_err"),i&&"function"==typeof i.fail&&i.fail("开始直播调用失败"),console.log("发送开始直播事件失败"))}})},stopLive:function(t,i){t.jsonp({url:"https://"+main_url+"/api/live/stop",callbackName:"callback",time:"30000",data:{roomid:t.roomid,userid:t.userid,loginid:t.viewerid},success:function(e){"OK"===e.result?(t.emit("end_live"),i&&"function"==typeof i.success&&i.success("结束直播调用成功"),console.log("成功发送结束直播事件")):(t.emit("end_live_err"),i&&"function"==typeof i.fail&&callback(!1,"结束直播调用失败"),console.log("发送结束直播事件失败"))}})},streamBreak:function(e){e.jsonp({url:"https://"+main_url+"/api/atlas/stream/break",callbackName:"callback",time:"30000",data:{roomid:e.roomid,userid:e.viewerid},success:function(e){e.result,console.log("通知api")}})},getNetPoint:function(e,t){e.jsonp({url:"https://"+main_url+"/api/dispatch",callbackName:"callback",time:"30000",success:function(e){"OK"===e.result?t&&"function"==typeof t.success&&t.success():t&&"function"==typeof t.fail&&t.fail()}})},getHistory:function(t,i){t.jsonp({url:"https://view.csslcloud.net/api/view/info",callbackName:"callback",time:"30000",data:{roomid:t.roomid,userid:t.userid},success:function(e){e.success?(i&&"function"==typeof i.success&&i.success(e),t.emit("get_history",e)):(i&&"function"==typeof i.fail&&i.fail("初始化文档失败:"+e.msg),console.log("初始化文档失败:"+e.msg))}})},getHistoryPlayBack:function(t,e){t.ajax({url:"https://ccapi.csslcloud.net/api/v1/serve/callback/info",type:"GET",data:{roomid:t.roomid,userid:t.userid,liveid:t.liveid},dataType:"json",async:!1,success:function(e){"OK"==(e=JSON.parse(e)).result||console.log("获取数据失败:"+e)},fail:function(e){t.emit("login_failed","网络请求失败"),console.log("login_failed",e)}})},insetgetUrl:function(n,s){n.ajax({type:"GET",url:"https://ccapi.csslcloud.net/api/record/media/track",data:s,dataType:"json",success:function(a){if("OK"==(a=JSON.parse(a)).result){window.insetVideo=new insetVideo;var e=a.data;if(0==e.length)return;for(var t=0;t<e.length-1;t++)for(var i=Math.floor(e[t].time/1e3),o=t+1;o<e.length;o++){i==Math.floor(e[o].time/1e3)&&(e.splice(t,1),o--)}var r=(a=e).length;t=0;!function t(i){if(i!=r){if(0<i&&a[i].mediaid==a[i-1].mediaid)a[i].url=a[i-1].url,t(i+1);else{var e={account_id:s.accountid,video_id:a[i].mediaid};n.ajax({type:"GET",url:"https://ccapi.csslcloud.net/api/v1/serve/video/playurl",data:e,dataType:"json",success:function(e){"OK"==(e=JSON.parse(e)).result&&(a[i].url=e.data.pc_playurl,t(i+1))}})}insetVideo.getUrl(a)}}(0)}}})},video_history_palyback:function(n,i){var e={roomid:i.roomid,accountid:i.userid,liveid:i.liveid};n.ajax({url:"https://ccapi.csslcloud.net/api/v1/serve/record/stream/query",type:"GET",data:e,dataType:"json",async:!1,success:function(e){if("OK"==(e=JSON.parse(e)).result)for(var a=e.data,t=0;t<a.length;t++){var o={account_id:i.userid,video_id:a[t].videoid},r=0;!function(i){n.ajax({url:"https://ccapi.csslcloud.net/api/v1/serve/video/playurl",type:"GET",data:o,dataType:"json",async:!0,success:function(e){if("OK"==(e=JSON.parse(e)).result){a[i].url=e.data.pc_playurl;var t=(new Date(a[i].start).getTime()-new Date(a[i].live_start).getTime())/1e3;a[i].Relative_start=t,(r+=1)==a.length&&CallbackPlayer.video_history_palyback(a)}else console.log("获取数据失败:"+e)},fail:function(e){n.emit("login_failed","网络请求失败"),console.log("login_failed",e)}})}(t)}else console.log("获取数据失败:"+e)},fail:function(e){n.emit("login_failed","网络请求失败"),console.log("login_failed",e)}})},getHistoryPlayBackDraw:function(r,e){var t={roomid:r.roomid,userid:r.userid,liveid:r.liveid,recordid:r.recordid};r.jsonp({url:"https://view.csslcloud.net/api/view/replay/draw/info",callbackName:"callback",time:"30000",data:t,dataType:"json",success:function(e){if(1==e.success){var o=e;r.jsonp({url:" https://view.csslcloud.net/api/view/replay/chatqa/info",callbackName:"callback",time:"30000",data:t,dataType:"json",success:function(e){if(console.log(e),1==e.success){var a=e;r.jsonp({url:"https://view.csslcloud.net/api/view/replay/info",callbackName:"callback",time:"30000",data:t,dataType:"json",success:function(e){if(1==e.success){var t=e,i={data:{meta:{draw:o.datas.meta.draw,chatLog:a.datas.meta.chatLog,pageChange:t.datas.meta.pageChange,animation:t.datas.meta.animation},template:o.datas.template}};console.log(i),r.emit("get_history_palyback",i),CallbackPlayer.get_history_palyback(i,r.joinData)}else console.log("获取数据失败:"+e)},fail:function(e){console.log("login_failed",e)}})}else console.log("获取数据失败:"+e)},fail:function(e){console.log("login_failed",e)}})}else console.log("获取数据失败:"+e)},fail:function(e){console.log("login_failed",e)}})},getHistoryPlayBackChat:function(e,t){return new Promise(function(t,i){e.jsonp({url:"http://view.csslcloud.net/api/view/replay/chatqa/info",callbackName:"callback",time:"30000",data:{roomid:e.roomid,userid:e.userid,liveid:e.liveid,recordid:e.recordid},dataType:"json",success:function(e){1==e.success?t(e):(console.log("获取数据失败:"+e),i(e))},fail:function(e){console.log("login_failed",e),i(e)}})})},getHistoryPlayBackReplay:function(e,t){return new Promise(function(t,i){e.jsonp({url:"http://view.csslcloud.net/api/view/replay/info",callbackName:"callback",time:"30000",data:{roomid:e.roomid,userid:e.userid,liveid:e.liveid,recordid:e.recordid},dataType:"json",success:function(e){1==e.success?t(e):(console.log("获取数据失败:"+e),i(e))},fail:function(e){console.log("login_failed",e),i(e)}})})}},o={things_arr:["chat_message","media_chat","publish_stream","end_stream","page_change","draw","room_user_count","room_user_list","switch_settings","silence_user_chat_message","recover_user_chat_message","switch_user_settings","start_rollcall","answer_rollcall","rollcall_list","room_timer","start_vote","stop_vote","reply_vote","vote_result","speak_lock","speak_rotate","device_fail","animation_change"],user:!(t.prototype.send_card_result=function(e){o.send_card_result(e)}),init:function(i){var e=this;function t(t){e.socket.on(t,function(e){i.emit(t,e)})}this.socket=io.connect(i.socket_address+"/"+i.roomid,{query:"sessionid="+i.sessionid,secure:!0}),new SocketSentinel(this.socket,i.socket_spare_address+"/"+i.roomid),this.socket.on("reconnect",function(e){console.log("成功重连"),i.emit("reconnect_user",e)}),this.socket.on("reconnecting",function(e){console.log("正在重连"),i.emit("reconnecting_user",e)}),this.socket.on("disconnect",function(e){console.log("断开连接"),i.emit("disconnect_user",e)}),this.socket.on("connect",function(e){console.log("连接成功"),i.emit("connect_user",e)}),this.socket.on("warn_teacher_selfdown",function(e){i.emit("warn_down",e)}),this.socket.on("kick_out",function(e){ATLAS.leave(),this.emit("disconnect"),i.emit("kick_out",e)}),this.socket.on("router",function(e){var t=JSON.parse(e);"avMedia"===t.action?"audioMedia"===t.type?i.emit("audio_player",t):"videoMedia"===t.type&&i.emit("video_player",t):"video_scale"===t.action&&i.emit("video_scale",t),"lock_screen"===t.type?"lock_screen_open"===t.action?i.emit("lock_screen_open",t):"lock_screen_close"===t.action&&i.emit("lock_screen_close",t):"republish"===t.type?i.emit("republish",t):"brainstom"===t.type?"send_brainstom"===t.action?i.emit("presenter_brainstom",t):"reply_brainstom"===t.action?i.emit("talker_brainstom",t):"end_brainstom"===t.action&&i.emit("end_brainstom",t):"vote"===t.type&&("send_vote"===t.action?i.emit("presenter_vote",t):"reply_vote"===t.action?i.emit("talker_vote",t):"end_vote"===t.action&&i.emit("end_vote",t))}),this.socket.on("room_context",function(e){r.roomContext(e,i),i.emit("room_context",e)}),this.socket.on("speak_context",function(e){r.speakContext(e,i),i.emit("speak_context",e)});for(var a=0;a<this.things_arr.length;a++){t(this.things_arr[a])}setTimeout(function(){try{o.socket.emit("room_user_count")}catch(e){}},1500),setInterval(function(){try{o.socket.emit("room_user_count")}catch(e){}},3e3)},socket_disconnect:function(){this.socket.disconnect()},send:function(e){return""!==e?(this.socket.emit("chat_message",e),!0):(console.log("msg is null"),!1)},media:function(e){return""!==e?(this.socket.emit("media_chat",e),!0):(console.log("msg is null"),!1)},flip:function(e,t){var i=t.startTime,a=Math.floor(((new Date).getTime()-i)/1e3),o={action:"page_change",value:{fileName:e.n,docid:e.id,totalPage:e.t,url:e.u,page:e.p,useSDK:e.useSDK,width:e.w,height:e.h,pageTitle:""+e.r},time:a};this.socket.emit("page_change",JSON.stringify(o))},do_animation:function(e,t){var i=t.startTime,a=Math.floor(((new Date).getTime()-i)/1e3),o={action:"animation_change",value:{docid:e.id,step:e.s,page:e.n},time:a};this.socket.emit("animation_change",JSON.stringify(o))},draw:function(e,t,i,a){var o=a.startTime,r={action:"draw",value:{fileName:e,page:t,data:i},time:Math.floor(((new Date).getTime()-o)/1e3)};this.socket.emit("draw",JSON.stringify(r))},videoDraw:function(e,t,i){var a=i.startTime,o={action:"draw",value:{value_type:"video_draw",fileName:e,page:-1,data:t},time:Math.floor(((new Date).getTime()-a)/1e3)};this.socket.emit("draw",JSON.stringify(o))},startRollcall:function(e,t,i){var a={rollcallId:t,publisherId:i.viewerid,duration:e};this.socket.emit("start_rollcall",JSON.stringify(a))},answerRollcall:function(e,t,i){var a={rollcallId:e,userId:i.viewerid,userName:i.name,publisherId:t};this.socket.emit("answer_rollcall",JSON.stringify(a))},moveInBlacklist:function(e,t){var i=void 0;try{if(!e)throw"输入操作用户的ID";var a={userId:e};this.socket.emit("blacklist_user",JSON.stringify(a))}catch(e){i=e}finally{"function"==typeof t&&t(i)}},moveOutFromAllList:function(e,t){var i=void 0;try{if(!e)throw"输入操作用户的ID";var a={userId:e};this.socket.emit("remove_list",JSON.stringify(a))}catch(e){i=e}finally{"function"==typeof t&&t(i)}},silenceChat:function(e){var t=void 0;try{this.socket.emit("silence_room_chat")}catch(e){t=e}finally{"function"==typeof e&&e(t)}},unSilenceChat:function(e){var t=void 0;try{this.socket.emit("recover_silence_room_chat")}catch(e){t=e}finally{"function"==typeof e&&e(t)}},switchUserSetting:function(e,t,i,a){var o={changed:e,userId:t,value:i,role:a};this.socket.emit("switch_user_settings",JSON.stringify(o))},kickOut:function(e,t){var i=void 0;try{if(!e)throw"参数错误";var a={userId:e};this.socket.emit("kick_out",JSON.stringify(a))}catch(e){i=e}finally{"function"==typeof t&&t(i)}},warnDown:function(e){var t={teacherId:e};this.socket.emit("warn_teacher_selfdown",JSON.stringify(t))},mediaPlayer:function(e){this.socket.emit("router",JSON.stringify(e))},sendCard:function(e,t,i,a){var o={publisherId:e,voteCount:t,voteId:i,voteType:a};this.socket.emit("start_vote",JSON.stringify(o))},stopAnswer:function(e){var t={voteId:e};this.socket.emit("stop_vote",JSON.stringify(t))},sendAnswer:function(e,t,i,a){var o={voteId:e,voteOption:t,publisherId:i,userName:a};this.socket.emit("reply_vote",JSON.stringify(o))},send_card_result:function(e){this.socket.emit("vote_result",JSON.stringify(e))}},a={getDevice:function(o){navigator.mediaDevices.enumerateDevices().then(function(e){if(0<e.length){console.log(e);var t={video:[],audio:[]};for(var i in e){var a=e[i];"videoinput"===a.kind&&t.video.push(a),"audioinput"===a.kind&&t.audio.push(a)}o&&"function"==typeof o.success&&o.success(t)}else o&&"function"==typeof o.fail&&o.fail("没有获取到设备")})}},r={streams:[],allow_streams:[],has_sub_streams:[],remove_streams:[],onlineUsers:[],userSettings:[],roomOptions:{},time:0,roomContext:function(e,t){var i=JSON.parse(e),a=i.onlineUsers,o=i.time;this.userSettings=i.userSettings,console.log("room_context",i),this.time>o||(this.time=o,this.onlineUsers=a,t.emit("online_users",a))},speakContext:function(e,t){var i=JSON.parse(e),a=i.down_by,o=i.onlineUsers;this.time=i.time,console.log("speak_context",i),a&&t.emit("teacher_down_by",a),this.onlineUsers=o,t.emit("online_users",o)}};window.Rtc=t,window.Speaker=r}(window);var CallbackPlayer=function(){var t=this;t.videoList={},t.videoObj={},t.livedata={},t.palyback_data={},t.isReady=!1,t.istchReady=!1,t.Nowtime=0,t.oldTime=-1,t.playVideoFlag=!1,this.appendVideo=function(r){var n=this,i="id"+r.videoid;if(!n.videoObj[i]&&r.url&&!(n.Nowtime>=n.livedata.Relative_live_end)){var e=document.createElement("source");e.setAttribute("src",r.url);var t=document.createElement("video");t.setAttribute("id",i),t.appendChild(e);var a=document.createElement("div");a.setAttribute("class","back-box");var o=document.createElement("li");if(o.setAttribute("id","p"+r.videoid),o.appendChild(t),o.appendChild(a),"presenter"==r.role){if(!document.getElementById("presenterVideo"))return void console.error("presenterVideo 不存在");document.getElementById("presenterVideo").appendChild(o)}else{if(!document.getElementById("studentVideo"))return void console.error("studentVideo 不存在");document.getElementById("studentVideo").appendChild(o)}n.videoObj[i]=new videojs(i,{muted:!1,controls:!1,loop:!1,preload:!0,controlBar:{volumePanel:{inline:!1}}},function(){var a=n.videoObj[i];a.role=r.role,n.Nowtime>r.Relative_start&&n.videoObj[i].currentTime(n.Nowtime-r.Relative_start),a.play(),a.on("timeupdate",function(e){}),a.on("ended",function(){clearInterval(a.isVideoBreak),a.dispose(),document.getElementById("p"+r.videoid).parentNode.removeChild(document.getElementById("p"+r.videoid)),delete n.videoObj[i]}),a.on("seeked",function(e){"presenter"==a.role&&(insetVideo.seek(),n.isReady&&!CallbackPlayer.playVideoFlag&&CallbackPlayer.funplayVideo())}),a.on("play",function(e){if(a.isPlay=!0,"presenter"==a.role);else{var t=document.getElementById(a.id()).parentElement.getElementsByClassName("back-box")[0];n.Nowtime>=r.Relative_start?t.style.display="none":(t.style.display="block",t.className="back-box back-box1")}}),a.on("pause",function(e){if(a.isPlay=!1,"presenter"==a.role);else{var t=document.getElementById(a.id()).parentElement.getElementsByClassName("back-box")[0];n.Nowtime>r.Relative_start?(t.style.display="block",t.className="back-box back-box2"):(t.style.display="block",t.className="back-box back-box1")}});for(var e=document.getElementById("studentVideo").getElementsByClassName("back-box"),t=0;t<e.length;t++)e[t].onclick=function(e){var t=e.srcElement.previousSibling.getAttribute("id");n.videoObj[t];e.srcElement.previousSibling.click()};a.on("click",function(e){console.log("你点击了视频"),n.playVideoFlag&&"presenter"!=a.role&&(a.isPlay?a.pause():n.Nowtime>=r.Relative_start&&(a.currentTime(n.Nowtime-r.Relative_start),a.play()))}),a.on("durationchange",function(e){setTimeout(function(){n.isReady&&(n.Nowtime<r.Relative_start?a.pause():n.Nowtime>r.Relative_start&&(a.currentTime(n.Nowtime-r.Relative_start),a.play()))},500),n.isReady||(n.isReady=!0,n.istchReady=!0,CallbackPlayer.emit("on_cc_live_player_init"),insetVideo.isPlay=!0,CallbackPlayer.playVideoFlag&&(CallbackPlayer.playVideoFlag=!1,clearInterval(CallbackPlayer.playVideo)),CallbackPlayer.funplayVideo()),a.playIntval()});var o=-1;tryTimes=0,a.playIntval=function(){a.isVideoBreak||(a.isVideoBreak=setInterval(function(){if(n.Nowtime==r.Relative_start&&a.play(),a.isPlay){var e=document.getElementById(a.id()).parentElement.getElementsByClassName("back-box")[0];n.Nowtime>=r.Relative_start?e.style.display="none":e.style.display="block"}if(5<++tryTimes){var t=a.currentTime(),i=Math.abs(t+r.Relative_start-n.Nowtime);t==o?"presenter"==a.role?a.currentTime(n.Nowtime-r.Relative_start):a.pause():2<=i?a.isPlay&&a.currentTime(n.Nowtime-r.Relative_start):o=t,tryTimes=0}(n.Nowtime<r.Relative_start-20||n.Nowtime>r.Relative_start+r.duration||n.Nowtime>=n.livedata.Relative_live_end)&&a.currentTime(n.livedata.Relative_live_end+6e7)},1e3))}})}},this.play=function(){var e=this;e.istchReady&&(e.Nowtime>=e.livedata.Relative_live_end?e.seek(0):e.isReady?e.pauseback():e.playback())},this.playback=function(){if(!this.isReady)for(var e in this.isReady=!0,CallbackPlayer.emit("on_spark_player_resume"),insetVideo.isPlay=!0,insetVideo.play(),CallbackPlayer.funplayVideo(),this.videoObj){this.videoObj[e].play()}},this.pauseback=function(){if(this.isReady)for(var e in this.isReady=!1,CallbackPlayer.emit("on_spark_player_pause"),insetVideo.isPlay=!1,insetVideo.pause(),CallbackPlayer.playVideoFlag=!1,clearInterval(CallbackPlayer.playVideo),this.videoObj){this.videoObj[e].pause()}},this.seek=function(e){var t=this;if((e=parseInt(e))<0||e>t.livedata.Relative_live_end)console.error("时间格式不正确");else if(t.istchReady){t.Nowtime=e,t.isReady=!1,CallbackPlayer.playVideoFlag=!1,clearInterval(CallbackPlayer.playVideo);var i=t.videoList;for(var a in i){var o=i[a];if(o.Relative_start<CallbackPlayer.Nowtime&&CallbackPlayer.Nowtime<=o.Relative_start+o.duration){var r="id"+a;t.videoObj[r]?o.Relative_start<CallbackPlayer.Nowtime&&t.videoObj[r].currentTime(t.Nowtime-o.Relative_start):t.appendVideo(o)}else{r="id"+a;t.videoObj[r]&&t.videoObj[r].currentTime(t.livedata.Relative_live_end+6e5)}}t.playback(),CallbackPlayer.emit("on_seekComplete")}},this.formatTimeS=function(e){return new Date(e).getTime()},this.get_history_palyback=function(e,t){CallbackPlayer.palyback_data=e;var i={allowDraw:!1,id:"draw-parent",liveid:t.liveid};CallbackPlayer.canvasInit(i)},this.video_history_palyback=function(e){var t={live_start:e[0].live_start,live_end:e[0].live_end,Relative_live_start:0,Relative_live_end:(this.formatTimeS(e[0].live_end)-this.formatTimeS(e[0].live_start))/1e3};this.livedata=t,this.videoList={};for(var i=0;i<e.length;i++){var a=e[i];a.videoid&&(this.videoList[a.videoid]=a).Relative_start<=20&&this.appendVideo(a)}},this.updatedVideo=function(){var e=this.videoList;for(var t in e){var i=e[t];i.Relative_start-20<=CallbackPlayer.Nowtime&&CallbackPlayer.Nowtime<=i.Relative_start+i.duration&&this.appendVideo(i)}},this.funplayVideo=function(){var e=this;e.chatLogdata=[],e.playVideoFlag=!0,this.openTime(),e.playVideo=setInterval(function(){e.Nowtime++,e.openTime()},1e3)},this.openTime=function(){var e=t.livedata.Relative_live_end||0;e<=t.Nowtime&&(t.Nowtime=e,t.playVideoFlag=!1,t.isReady=!1,clearInterval(t.playVideo),CallbackPlayer.emit("on_spark_player_end"),insetVideo.isPlay=!1,insetVideo.end());t.emit("PlayTime",{getPlayerTime:t.Nowtime,getBufferTime:0,getDurationTime:e}),t.funchatLog(),t.funGetPlayerTime(t.Nowtime),t.updatedVideo(),t.oldTime=t.Nowtime},this.funchatLog=function(){var e=CallbackPlayer.palyback_data.data.meta.chatLog.filter(function(e){return e.time<=CallbackPlayer.Nowtime});this.chatLogdata.length!==e.length&&(this.chatLogdata=e,CallbackPlayer.emit("chatLogdata",e))},this.funGetPlayerTime=function(e){var t=CallbackPlayer;t.docBeforeList=[],t.animationBefore=[];e=e||t.Nowtime;var i=CallbackPlayer.palyback_data,a=i.data.meta.draw,o=i.data.meta.pageChange,r=i.data.meta.animation;if(CallbackPlayer.Nowtime-CallbackPlayer.oldTime==1){for(var n in o)o[n].time==CallbackPlayer.Nowtime&&DP.flip(o[n]);for(var n in r)r[n].time==CallbackPlayer.Nowtime&&DP.do_animation(r[n]);for(var n in DP.clearRect(),a)a[n].time<=CallbackPlayer.Nowtime&&DP.draw(a[n].data)}else{for(var n in o)o[n].time<=CallbackPlayer.Nowtime&&t.docBeforeList.push(o[n]);var s=t.docBeforeList.pop(),l=s.docId+"_"+s.pageNum;for(var n in l!=DP.currentDocKey&&DP.flip(s),r)r[n].time<=CallbackPlayer.Nowtime&&t.animationBefore.push(r[n]);var c=t.animationBefore.pop();for(var n in t.animationBefore.length&&s.time<c.time&&DP.do_animation(c),DP.clearRect(),a)a[n].time<=CallbackPlayer.Nowtime&&DP.draw(a[n].data)}},this.getPlayerTime=function(){return this.Nowtime}},insetVideo=function(){var d=this;d.videodata=[],d.videodataI={},d.ogetPlayerTime=-1,d.isPlay=!1,d.Mediaisplay=!1,d.isInterval=!1,d.$insetVideo=null,d.$Media=null,d.isiPhone=-1<navigator.userAgent.indexOf("iPhone"),CallbackPlayer=CallbackPlayer||$.DW,d.getUrl=function(e){d.videodata=e,d.openInset()},d.openInset=function(){d.isInterval||(d.Interval=setInterval(function(){d.isInterval=!0;var e=CallbackPlayer.getPlayerTime();d.ogetPlayerTime=e,d.openMedia()},1e3))},d.openMedia=function(){for(var e=d.videodata,t=Math.floor(d.ogetPlayerTime),i=0;i<e.length;i++){(l=Math.floor(e[i].time/1e3))==t&&d.appendMedia(e[i])}if(d.$insetVideo&&2==d.$insetVideo.getAttribute("type"))if(d.$Media.paused)d.$insetVideo.getElementsByClassName("play-pause")[0].className="play-pause pause";else{d.$insetVideo.getElementsByClassName("play-pause")[0].className="play-pause play";var a=Math.floor(d.$Media.currentTime),o=a/(n=Math.floor(d.$Media.duration))*100+"%";d.$insetVideo.getElementsByClassName("played")[0].innerText=d.sec_to_time(a),d.$insetVideo.getElementsByClassName("duration")[0].innerText=d.sec_to_time(n),d.$insetVideo.getElementsByClassName("progress")[0].style.width=o}var r=d.videodataI;if(d.$Media&&d.$Media.duration&&"{}"!==JSON.stringify(r)){var n=d.$Media.duration,s=(t=CallbackPlayer.getPlayerTime(),parseInt(r.pos)),l=parseInt(r.time/1e3),c=Math.round((t-l+s)%n);2<=Math.abs(d.$Media.currentTime-c)&&d.Mediaisplay&&(d.$Media.currentTime=c)}},d.appendMedia=function(r){r=r;if(d.videodataI=r,document.getElementById("insetVideo")){if((i=d.$insetVideo.getAttribute("mediaid"))!=r.mediaid){d.Mediaisplay=!1;var e=document.getElementById("insetVideo");if(e.parentNode.removeChild(e),(t=document.createElement("div")).setAttribute("id","insetVideo"),t.setAttribute("mediaid",r.mediaid),t.setAttribute("type",r.type),1==r.type){t.className="inset-Video";i="id"+r.mediaid,a='<p class="inset-title">'+r.filename+'</p><div class="media-box"><video id="'+i+'" src="'+r.url+'" loop="loop"></video></div>'}else if(2==r.type){t.className="inset-Audio";i="id"+r.mediaid,a='<p class="inset-title">'+r.filename+'</p><div class="media-box"><audio id="'+i+'" src="'+r.url+'" loop="loop"></audio><div class="play-pause play"></div><div class="scrubber"><div class="progress" style="width: 0%;"></div></div><div class="time"><em class="played">00:02</em>/<strong class="duration">04:34</strong></div></div>'}t.innerHTML=a,document.getElementById("insetMedia").appendChild(t),d.$insetVideo=document.getElementById("insetVideo"),d.$Media=document.getElementById("id"+r.mediaid),d.isiPhone,window.insetMediaCreateDom&&insetMediaCreateDom()}}else{if(-1==r.operate)return;var t;if((t=document.createElement("div")).setAttribute("id","insetVideo"),t.setAttribute("mediaid",r.mediaid),t.setAttribute("type",r.type),1==r.type){t.className="inset-Video";var i="id"+r.mediaid,a='<p class="inset-title">'+r.filename+'</p><div class="media-box"><video id="'+i+'" src="'+r.url+'" loop="loop"></video></div>'}else if(2==r.type){t.className="inset-Audio";var i="id"+r.mediaid,a='<p class="inset-title">'+r.filename+'</p><div class="media-box"><audio id="'+i+'" src="'+r.url+'" loop="loop"></audio><div class="play-pause play"></div><div class="scrubber"><div class="progress" style="width: 0%;"></div></div><div class="time"><em class="played">00:02</em>/<strong class="duration">04:34</strong></div></div>'}t.innerHTML=a,document.getElementById("insetMedia").appendChild(t),d.$insetVideo=document.getElementById("insetVideo"),d.$Media=document.getElementById("id"+r.mediaid),d.isiPhone,window.insetMediaCreateDom&&insetMediaCreateDom()}if(1==r.operate){if(d.isPlay&&d.$Media.play(),d.Mediaisplay=!0,c=d.$Media.duration){var o=CallbackPlayer.getPlayerTime(),n=parseInt(r.pos),s=parseInt(r.time/1e3),l=Math.round((o-s+n)%c);d.$Media.currentTime=l}}else if(0==r.operate){if(d.Mediaisplay=!1,d.$Media.pause(),c=d.$Media.duration){o=CallbackPlayer.getPlayerTime(),n=parseInt(r.pos),s=parseInt(r.time/1e3),l=Math.round((o-s+n)%c);d.$Media.currentTime=l}}else if(2==r.operate){var c;if(1==r.last_operate?(d.isPlay?d.$Media.play():d.$Media.pause(),d.Mediaisplay=!0):(d.$Media.pause(),d.Mediaisplay=!1),c=d.$Media.duration){o=CallbackPlayer.getPlayerTime(),n=parseInt(r.pos),s=parseInt(r.time/1e3),l=Math.round((o-s+n)%c);1==r.last_operate?d.$Media.currentTime=l:d.$Media.currentTime=r.pos}}else-1==r.operate&&d.end();d.$Media.addEventListener("durationchange",function(){var e=d.$Media.duration,t=CallbackPlayer.getPlayerTime(),i=parseInt(r.pos),a=parseInt(r.time/1e3),o=Math.round((t-a+i)%e);d.$Media.currentTime=o})},d.pause=function(){insetVideo&&insetVideo.Mediaisplay&&insetVideo.$Media&&insetVideo.$Media.pause()},d.play=function(){insetVideo&&insetVideo.Mediaisplay&&insetVideo.$Media&&insetVideo.$Media.play()},d.seek=function(){var e=d.videodata;if(0<e.length){for(var t=Math.floor(CallbackPlayer.getPlayerTime()),i=[],a=0;a<e.length;a++){var o=e[a];parseInt(o.time/1e3)<=t&&i.push(o)}var r=i[i.length-1];r?d.appendMedia(r):d.end()}},d.end=function(){if(document.getElementById("insetVideo")){d.Mediaisplay=!1;var e=document.getElementById("insetVideo");e.parentNode.removeChild(e),d.isiPhone,window.insetMediaRemoveDom&&insetMediaRemoveDom()}},d.sec_to_time=function(e){var t="";if(-1<e){var i=Math.floor(e/3600),a=Math.floor(e/60)%60,o=e%60;3600<=e&&(t=i<10?"0"+i+":":i+":"),a<10&&(t+="0"),t+=a+":",o<10&&(t+="0"),t+=o}return t}};function getHexRGB(e){for(var t=parseInt(e,10).toString(16).toUpperCase(),i=t.length,a=0;a<6-i;a++)t="0"+t;return"#"+t}function setCookie(e,t,i){var a=new Date;a.setTime(a.getTime()+24*i*60*60*1e3);var o="expires="+a.toUTCString();document.cookie=e+"="+t+"; "+o+"; path=/",console.log(a)}function getCookie(e){var t,i=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(i))?unescape(t[2]):null}CallbackPlayer.prototype=Rtc.prototype,function(s,_,P){var S,l,a,c,o,d;function e(e){this.mode=e.mode||0,this.filesObject=e.files,this.uploadCallbackBefore=e.uploadCallbackBefore,this.uploadCallbackSuccess=e.uploadCallbackSuccess,this.uploadCallbackFailed=e.uploadCallbackFailed,this.init()}Rtc.prototype.canvasInit=function(e){S=this;var i=e.allowDraw;l=e.id,e.liveId&&(c=e.liveId,O.getBoard()),d=e.pptDisplay?1:0;if(P("#"+l).append('<div id="draw-box"><div id="draw"><canvas id="draw-board"></canvas><iframe id="dpa" allow-scripts allowfullscreen allowusermedia frameborder="0" allow="autoplay"></iframe><div class="fluo-dis fluo-con" id="DOMfluorescence"><div class="backg-c"></div></div><div class="fluo-dis fluo-ear" id="DOMerasureBack"><div class="backg-c"></div></div></div></div>'),p.load(),DP=new r,DP.init(i),a=new Dpc,S.on("publish_stream",function(){S.startTime=(new Date).getTime(),DP.clearCache(),i&&u.flip()}),S.on("end_stream",function(){DP.clearCache(),c=""}),S.on("page_change",function(e){var t=JSON.parse(e);u.current_animation=0,t.value.url=t.value.url.replace("http:","https:"),i||DP.flip(JSON.stringify(t.value))}),S.on("animation_change",function(e){e=JSON.parse(e);u.current_animation=e.value.step;var t={id:e.value.docid,s:e.value.step,n:e.value.page};i||DP.do_animation(t)}),S.on("live_start",function(e){c=e.liveId}),!c){var t={action:"history",data:{name:u.name,id:u.id}};S.emit("flipMessage",t)}},Rtc.prototype.getSingleDocument=function(e){t.getSingleDocument(this,e)},Rtc.prototype.getInstructionAllDocument=function(e){t.getInstructionAllDocument(this,e)},Rtc.prototype.cancelDocument=function(e){t.cancelDocument(this,e)},Rtc.prototype.drawChange=function(e){N.drawChange(this,e)},Rtc.prototype.docChange=function(e){N.docChange(this,e)},e.prototype={constructor:e,init:function(){try{if(null==this.filesObject)throw new ReferenceError("upload the file is not exist, place choose upload the file, again to upload the file");if("function"!=typeof this.uploadCallbackSuccess)throw new TypeError("Assert uploadCallbackSuccess is not function. you need to typeof uploadCallbackSuccess is function.");if("function"!=typeof this.uploadCallbackFailed)throw new TypeError("Assert uploadCallbackFailed is not function. you need to typeof uploadCallbackSuccess is function.");if("function"!=typeof this.uploadCallbackBefore)throw new TypeError("Assert uploadCallbackBefore is not function. you need to typeof uploadCallbackBefore is function.")}catch(e){return"function"==typeof this.uploadCallbackFailed?this.uploadCallbackFailed(e):alert(e),null}var e=0;if(e=1048576<this.filesObject.size?(Math.round(100*this.filesObject.size/1048576)/100).toString()+"MB":(Math.round(100*this.filesObject.size/1024)/100).toString()+"KB",this.fileSize=e,this.fileType=this.filesObject.type,this.fileName=this.filesObject.name,this.AssertFilesType())return this.uploadCallbackFailed("Assert upload file type is not support, place change the file type, again upload the file!"),null;this.getUpLoadUrl(this.filesObject.size,this.fileName)},getUpLoadUrl:function(e,t){var i=this,a=this.mode;P.get("https://"+main_url+"/api/v1/serve/doc/add",{account_id:S.userid,doc_name:t,doc_size:e,room_id:S.roomid,allow_animation:a},function(e){console.log(e,"-------------------"),"OK"===e.result?(i.url=e.data.upload_url,i.uploadFile()):("function"==typeof i.uploadCallbackFailed&&i.uploadCallbackFailed("get upload url err"),console.log(e))})},uploadFile:function(){var e=new FormData,t=this.url;e.append("file",this.filesObject);var i=Date.parse(new Date),o=this;P.ajax({type:"post",url:t,async:!0,contentType:!1,processData:!1,data:e,dataType:"text",beforeSend:function(e){o.uploadCallbackBefore(i)},success:function(e){!0!==(e=JSON.parse(e)).success?o.uploadCallbackFailed(e,i):o.uploadCallbackSuccess(e,i)},error:function(e,t,i,a){o.uploadCallbackFailed(i)}})},AssertFilesType:function(){var e=this.fileName.split("."),t="."+e[e.length-1];return this.fileExtension=t,-1===[".doc",".docx",".ppt",".pptx",".pdf",".jpg"].indexOf(this.fileExtension)}};var t={getSingleDocument:function(e,t){if(!e||!t||!t.docId)return null;P.ajax({url:"https://ccapi.csslcloud.net/api/v1/serve/doc/auth/list",type:"GET",dataType:"json",data:{account_id:e.userid,room_id:e.roomid,doc_id:t.docId},success:function(e){"function"==typeof t.getSingleDocumentCallback&&t.getSingleDocumentCallback(e,t.docId)}})},getInstructionAllDocument:function(e,t){if(!e||!t)return null;P.ajax({url:"https://ccapi.csslcloud.net/api/doc/auth/list",type:"GET",dataType:"json",data:{room_id:e.roomid,account_id:e.userid,is_migrate:1},success:function(e){"OK"===e.result?"function"==typeof t.getInstructionAllDocumentSuccess&&t.getInstructionAllDocumentSuccess(e):"function"==typeof t.getInstructionAllDocumentFailed&&t.getInstructionAllDocumentFailed(e)}})},cancelDocument:function(e,t){if(!e||!t||!t.docId)return null;P.ajax({url:"https://ccapi.csslcloud.net/api/doc/unrelate",type:"POST",dataType:"json",data:{room_id:e.roomid,doc_id:t.docId},success:function(e){"OK"===e.result?"function"==typeof t.cancelDocumentSuccess&&t.cancelDocumentSuccess(e,t.docId):"function"==typeof t.cancelDocumentFailed&&t.cancelDocumentFailed(e,t.docId)}})}},T={preType:2,alpha:1,color:"0",docid:"WhiteBorad",width:P("#draw").width(),height:P("#draw").height(),page:0,thickness:1,type:2,fontSize:15,draw:"",mode:0,useSDK:!1,name:"WhiteBorad",viewername:"",viewerid:"",drawid:""},u={name:"WhiteBorad",id:"WhiteBorad",totalpage:1,domain:"//image.csslcloud.net",useSDK:!1,docFromRoomId:"",currentPage:0,url:"#",mode:0,useSDK:!1,whiteArr:[0],whiteNum:0,relativePage:1,animation_count:0,current_animation:0,slideTo:function(e){e=parseInt(e);"WhiteBorad"===u.name?(T.page=this.currentPage=this.whiteArr[e-1],this.relativePage=e):T.page=this.currentPage=e-1,this.flip()},prePage:function(){if("WhiteBorad"===this.name){if(1===this.relativePage)return;this.relativePage=this.relativePage-1,this.currentPage=this.whiteArr[this.relativePage-1],this.flip()}else 0==this.currentPage?this.currentPage=0:(this.currentPage--,this.flip())},nextPage:function(){if("WhiteBorad"===this.name){if(this.relativePage===this.totalpage)return;this.relativePage=this.relativePage+1,this.currentPage=this.whiteArr[this.relativePage-1],this.flip(this.pic_domain)}else this.currentPage<Number(this.totalpage-1)&&(this.currentPage++,this.flip())},flip:function(){},do_animation:function(e){e&&(u.current_animation=e);var t={id:u.id,s:u.current_animation,n:u.currentPage};DP.do_animation(t),S.do_animation(t)}},p={allow_draw:!0,dp:P("#draw-board"),setting:function(){this.$=function(e){return"string"==typeof e?_.getElementById(e):e},this.canvas=this.$("draw")},load:function(){this.x=[],this.y=[],this.lock=!1,this.setting(),this.touch=!1,this.DOMfluorescence=this.$("DOMfluorescence"),this.DOMerasureBack=this.$("DOMerasureBack"),this.StartEvent=this.touch?"touchstart":"mousedown",this.MoveEvent=this.touch?"touchmove":"mousemove",this.EndEvent=this.touch?"touchend":"mouseup",this.StartOver=this.touch?"touchstart":"mouseover",this.MoveOut=this.touch?"touchend":"mouseout",this.bind()},bind:function(){var k=this;k.clk=0,P(_).on("click","#draw-board",function(e){if(k.allow_draw){if(5!=T.type)return;if(0<P("#drag_input").length){var t=P(".textInput"),i=t.html().replace(/<div>/g,"\n").replace(/<\/div>/g,"").replace(/\\<br>/g,"").replace(/&nbsp;/g,"").replace(/<br>/g,""),a=(t.offset().left-P(this).offset().left)/P(this).attr("width"),o=(t.offset().top-P(this).offset().top)/P(this).attr("height");T.draw={x:a,y:o,label:i,width:t.width()*DP.tp_w/P(this).attr("width"),height:t.height()*DP.tp_h/P(this).attr("height"),width_per:t.width()/P(this).attr("width"),height_per:t.height()/P(this).attr("height"),size:T.fontSize};var r=T.page,n=T.name;T.width=P("#draw").width(),T.height=P("#draw").height(),T.drawid=S.viewerid+(new Date).getTime(),T.viewername=S.name,T.viewerid=S.viewerid;var s=JSON.stringify(T),l=JSON.parse(s);P.trim(i)&&(DP.draw(l,!1),S.draw(n,r,l)),t.remove(),k.clk=0,T.draw=""}else{if(k.clk=!k.clk,k.clk){var c=parseInt(T.fontSize),d=parseInt(c*P("#draw-board").width()/DP.tp_w);P("body #draw").append('<div id="drag_input" class="textInput" contenteditable="true"></div>'),P(".textInput").css({position:"absolute",display:"inline-block",top:e.offsetY,left:e.offsetX,"text-align":"left","z-index":"999999",color:C(T.color),"min-width":"10px","max-width":"100%",background:"#fff",border:"1px solid gray","font-size":d+"pt",cursor:"move"}).focus()}else P(".textInput").remove()}}}),this.canvas["on"+k.StartOver]=function(e){var t=k.touch?e.touches[0]:e;T.width=P("#draw").width(),T.height=P("#draw").height(),10==T.type?(t.target.style.cursor="none",1==T.thickness?T.erasureType=1*T.width/200:3==T.thickness?T.erasureType=2*T.width/200:5==T.thickness&&(T.erasureType=3*T.width/200),k.DOMerasureBack.style.width=2*T.erasureType+"px",k.DOMerasureBack.style.height=2*T.erasureType+"px",k.DOMerasureBack.style.display="block"):12==T.type?(t.target.style.cursor="none",k.DOMfluorescence.style.display="block",k.lock=!1):5==T.type?(t.target.style.cursor="Default",P(".textInput").css("cursor","move"),P(".textInput div").removeAttr("style")):t.target.style.cursor="Default"},this.canvas["on"+k.StartEvent]=function(e){if(k.allow_draw){var t=k.touch?e.touches[0]:e;if(5!=T.type&&12!=T.type){if(10==T.type){var i=t.clientX-P("#draw").offset().left,a=t.clientY-P("#draw").offset().top;k.movePoint(i,a);var o=k.x[0],r=k.y[0];T.draw=[{x:o,y:r}];var n=JSON.stringify(T),s=JSON.parse(n);DP.draw(s,!0)}else{i=t.offsetX,a=t.offsetY;k.movePoint(i,a)}DP.save(),k.lock=!0}}},this.canvas["on"+k.MoveEvent]=function(e){if(k.allow_draw){var t=k.touch?e.touches[0]:e;if(k.lock){if(DP.restore(),10==T.type)var i=t.clientX-P(this).offset().left,a=t.clientY-P(this).offset().top;else i=t.offsetX,a=t.offsetY;k.movePoint(i,a);for(var o=k.x[0],r=k.y[0],n="",s="",l={},c=[],d=0;d<k.x.length;d++)n=k.x[k.x.length-1]-o,s=k.y[k.x.length-1]-r,l.x=k.x[d],l.y=k.y[d],l=JSON.stringify(l),l=JSON.parse(l),c.push(l);var u=Math.sqrt(Math.pow(n*T.width,2)+Math.pow(s*T.height,2));switch(T.type){case 2:T.draw=c;break;case 3:var p={x:o,y:r,width:n,height:s};T.draw=p;break;case 4:var h=u/T.width,m=u/T.height,f={x:o+h,y:r+m,heightRadius:m,widthRadius:h};T.draw=f;break;case 10:case 11:case 13:T.draw=c}var g=JSON.stringify(T),v=JSON.parse(g);DP.draw(v,!0)}else if(12==T.type){T.draw=[];i=t.pageX-this.getBoundingClientRect().left-k.DOMfluorescence.offsetWidth/2,a=t.pageY-this.getBoundingClientRect().top-k.DOMfluorescence.offsetHeight/2;k.movePoint(i,a);n="",s="";var y={},w=[];for(d=0;d<k.x.length;d++)y.x=k.x[d],y.y=k.y[d],y=JSON.stringify(y),y=JSON.parse(y),(w=[]).push(y);var _=T.page,b=T.name;T.width=P("#draw").width(),T.height=P("#draw").height(),T.drawid=S.viewerid+(new Date).getTime(),T.viewername=S.name,T.viewerid=S.viewerid,T.draw=w;g=JSON.stringify(T),v=JSON.parse(g);DP.draw(v,!0),S.draw(b,_,v),k.x=[],k.y=[]}if(10==T.type){i=t.pageX-this.getBoundingClientRect().left-T.erasureType,a=t.pageY-this.getBoundingClientRect().top-T.erasureType;k.DOMerasureBack.style.left=i+"px",k.DOMerasureBack.style.top=a+"px"}}},this.canvas["on"+k.EndEvent]=function(e){if(k.allow_draw){if(k.lock=!1,k.x=[],k.y=[],""==T.draw)return;if(5==T.type||12==T.type)return;if(2==T.type&&!T.draw.length)return;var t=T.page,i=T.name;T.width=P("#draw").width(),T.height=P("#draw").height(),T.drawid=S.viewerid+(new Date).getTime(),T.viewername=S.name,T.viewerid=S.viewerid,S.draw(i,t,T);var a=JSON.stringify(T),o=JSON.parse(a);DP.draw(o,!1),T.draw=""}},P("#draw").on("mouseleave",function(e){if(k.allow_draw){if(k.lock){if(k.lock=!1,k.x=[],k.y=[],""==T.draw)return;if(5==T.type)return;if(2==T.type&&!T.draw.length)return;var t=T.page,i=T.name;T.width=P("#draw").width(),T.height=P("#draw").height(),T.drawid=S.viewerid+(new Date).getTime(),T.viewername=S.name,T.viewerid=S.viewerid,S.draw(i,t,T);var a=JSON.stringify(T),o=JSON.parse(a);DP.draw(o,!1),T.draw=""}else if(12==T.type){T.draw="";t=T.page,i=T.name;T.width=P("#draw").width(),T.height=P("#draw").height(),T.drawid=S.viewerid+(new Date).getTime(),T.viewername=S.name,T.viewerid=S.viewerid,S.draw(i,t,T),DP.draw(T,!0)}if(10==T.type)(k.touch?e.touches[0]:e).target.style.cursor="Auto",k.DOMerasureBack.style.display="none"}})},movePoint:function(e,t){this.x.push(e/P("#draw").css("width").replace(/px/,"")),this.y.push(t/P("#draw").css("height").replace(/px/,""))},sendClear:function(){var e=T.page,t=T.name;T.type=0,T.drawid=S.viewerid+(new Date).getTime(),T.viewername=S.name,T.viewerid=S.viewerid;var i=JSON.stringify(T),a=JSON.parse(i);DP.clearScreen(a),S.draw(t,e,T),T.draw="",T.type=T.preType},clearPrev:function(){for(var e=T.page,t=T.name,i=!(T.type=9),a=T.docid+"_"+T.page,o=DP.caches[a].draws,r=o.length-1;0<=r;r--)if(o[r].viewerid===S.viewerid){T.drawid=o[r].drawid,i=!0;break}T.viewername=S.name,T.viewerid=S.viewerid,i&&(DP.clearPrev(T),S.draw(t,e,T)),T.draw="",T.type=T.preType}},r=function(e){if(this.id="draw-board",this.canvas=_.getElementById(this.id),this.cxt=this.canvas.getContext("2d"),!this.canvas)throw new Error("canvas is not exist");this.caches={},this.currentDocKey="WhiteBorad_0",this.zoom=1,this.imgmess="",this.dtw="",this.dth="",this.DOMfluorescence=_.getElementById("DOMfluorescence")},n=0,h=9,m=2,f=3,g=4,v=5,y=6,w=7,b=10,k=11,x=12,D=13;r.prototype={init:function(e){var o,r,n;this.reInit(e),S.on("draw",function(e){if((e=JSON.parse(e)).value.data.viewerid===S.viewerid)return!1;DP.draw(e.value.data)}),e||(p.allow_draw=!1),P(_).on("mousedown","#drag_input",function(e){_event=e||s.event,target=_.getElementById("drag_input"),r=_event.clientX-target.offsetLeft,n=_event.clientY-target.offsetTop,o=target}),_.onmousemove=function(e){if(o){_event=e||s.event;var t=_event.clientX-r,i=_event.clientY-n;draw_box=_.getElementById("draw-box"),t<0&&(t=0),t>draw_box.offsetWidth-o.offsetWidth&&(t=draw_box.offsetWidth-o.offsetWidth),i<0&&(i=0),i>draw_box.offsetHeight-o.offsetHeight&&(i=draw_box.offsetHeight-o.offsetHeight);var a=_.getElementById("drag_input");a.style.left=t+"px",a.style.top=i+"px"}},_.onmouseup=function(e){o=null}},reInit:function(e){P("#draw-board").attr("width",P("#draw-box").css("width").replace(/px/,"")),P("#draw-board").attr("height",P("#draw-box").css("height").replace(/px/,"")),P("#draw").css({width:P("#draw-box").css("width"),height:P("#draw-box").css("height"),"margin-top":"0"});var t=_.getElementById(this.id);this.dtw=this.tp_w=t.width,this.dth=this.tp_h=t.height},clearCache:function(){this.caches={},this.clearRect()},save:function(){this.SID=this.cxt.getImageData(0,0,this.canvas.width,this.canvas.height)},restore:function(){this.SID&&this.cxt.putImageData(this.SID,0,0)},flip:function(e){if(e){e=function(e){"string"==typeof e&&(e=JSON.parse(e));return e}(e),p.lock=!1,p.x=[],p.y=[],T.draw="",u.name=T.name=e.docName,u.id=T.docid=e.docId,u.totalpage=e.docTotalPage,u.currentPage=T.page=e.pageNum,e.pageTitle?u.relativePage=Number(e.pageTitle):u.relativePage=e.pageTitle;var a=this;I(e)&&a.reInit(p.allow_draw),a.ResetZoom("reset");var t=e.docId+"_"+e.pageNum;a.currentDocKey=t,a.caches[t]?a.caches[t].j||(a.caches[t].j=e):a.caches[t]={doc:{id:e.docId,num:e.pageNum,url:e.url,isWhiteBorad:I(e)},j:e,draws:[]};var o=_.getElementById(a.id),i=o.getContext("2d"),r={time:e.time,url:e.url,docId:e.docId,docName:e.docName,docTotalPage:e.docTotalPage,pageNum:e.pageNum,encryptDocId:e.encryptDocId,useSDK:e.useSDK,width:e.width,height:e.height,mode:e.mode,pageTitle:e.pageTitle},n={action:"flip",data:{id:e.docid,name:e.fileName,totalPage:e.totalPage}};if("WhiteBorad"===e.fileName?n.data.currentPage=Number(u.relativePage):n.data.currentPage=Number(e.page)+1,I(e))i.clearRect(0,0,o.width,o.height),p.setting(),a.pageChange(r);else{var s=new Image,l=e.url;(a.imgmess=s).crossOrigin="",s.src=l,s.onload=function(){var e=a.tp_h=this.height,t=a.tp_w=this.width;if(0===d){var i=t/e;P("#draw-box").width()/P("#draw-box").height()<=i?(o.width=P("#draw-box").width(),o.height=parseInt(o.width*e/t)):(o.height=P("#draw-box").height(),o.width=parseInt(o.height*t/e))}else o.width=P("#draw-box").width()-20,o.height=parseInt(o.width*e/t);P("#draw").css({width:o.width+"px",height:o.height+"px"}),r.width=o.width,r.height=o.height,a.pageChange(r),a.setMargin(),a.dtw=o.width,a.dth=o.height}}}},pageChange:function(e){"#"!==e.url&&-1===e.url.indexOf("https:")&&-1===e.url.indexOf("http:")&&(e.url="https:"+e.url);var t=JSON.stringify(e);o&&"#"!==e.url&&o.url===e.url&&a.clear(),a.pageChange(t),o=e},do_animation:function(e){var t={time:e.time,docTotalPage:e.docTotalPage,pageNum:e.pageNum,encryptDocId:e.encryptDocId,step:e.step};a.animationChange(JSON.stringify(t))},clearRect:function(){var e=_.getElementById(this.id);e.getContext("2d").clearRect(0,0,e.width,e.height)},clearDocDraws:function(e){var i=e.docid;P.each(this.caches,function(e,t){0<=e.indexOf(i)&&s.DP&&s.DP.caches&&delete s.DP.caches[e]})},clearScreen:function(e){this.clearRect();var t=e.docid+"_"+e.page;this.caches[t]&&(this.caches[t].draws=[]);var i=_.getElementById(this.id);i.getContext("2d").clearRect(0,0,i.width,i.height)},clearPrev:function(e){var i=this;i.clearRect();for(var t=e.docid+"_"+e.page,a=e.drawid,o=i.caches[t].draws,r=o.length-1;0<=r;r--)o[r].drawid===a&&i.caches[t].draws.splice(r,1);P.each(i.caches[t].draws,function(e,t){i.draw(t,!0)})},deleteDoc:function(e){this.clearRect()},drawLine:function(e){var t=_.getElementById(this.id),i=t.getContext("2d");if(e.draw[0]){var a=e.draw[0].x*t.width,o=e.draw[0].y*t.height;i.beginPath(),i.strokeStyle=C(e.color),i.lineWidth=e.thickness*t.width/t.width,i.lineJoin="round",i.moveTo(a,o);for(var r=0;r<e.draw.length;r++){var n=e.draw[r].x*t.width,s=e.draw[r].y*t.height;i.lineTo(n,s)}i.stroke()}},laserPen:function(e){var t=_.getElementById(this.id),i=t.getContext("2d");if(e.draw[0]){var a=e.draw[0].x*t.width,o=e.draw[0].y*t.height;i.beginPath(),i.strokeStyle=C(e.color),i.lineWidth=3*e.thickness*t.width/t.width,i.lineJoin="round",i.moveTo(a,o);for(var r=0;r<e.draw.length;r++){var n=e.draw[r].x*t.width,s=e.draw[r].y*t.height;i.lineTo(n,s)}i.stroke()}},drawRect:function(e){var t=_.getElementById(this.id),i=t.getContext("2d"),a=e.draw.x*t.width,o=e.draw.y*t.height,r=e.draw.width*t.width,n=e.draw.height*t.height;i.beginPath(),i.strokeStyle=C(e.color),i.lineWidth=e.thickness*t.width/t.width,i.lineJoin="round",i.strokeRect(a,o,r,n),i.stroke()},straightLine:function(e){var t=_.getElementById(this.id),i=t.getContext("2d");if(e.draw[0]){var a=e.draw[0].x*t.width,o=e.draw[0].y*t.height,r=e.draw[e.draw.length-1].x*t.width,n=e.draw[e.draw.length-1].y*t.height;i.beginPath(),i.strokeStyle=C(e.color),i.lineWidth=e.thickness*t.width/t.width,i.lineJoin="round",i.moveTo(a,o),i.lineTo(r,n),i.stroke()}},fluorescence:function(e){var t=_.getElementById(this.id);t.getContext("2d");if(e.draw){this.DOMfluorescence.style.display="block";var i=e.draw[e.draw.length-1].x*t.width,a=e.draw[e.draw.length-1].y*t.height;this.DOMfluorescence.style.left=i+"px",this.DOMfluorescence.style.top=a+"px"}else this.DOMfluorescence.style.display="none"},drawArc:function(e){var t=_.getElementById(this.id),i=t.getContext("2d"),a=e.draw.heightRadius*t.height,o=e.draw.x*t.width-a,r=e.draw.y*t.height-a;i.beginPath(),i.strokeStyle=C(e.color),i.lineWidth=e.thickness*t.width/t.width,i.lineJoin="round",i.arc(o,r,a,0,2*Math.PI,!0),i.stroke()},clearERASURE:function(e){var t=_.getElementById(this.id),a=t.getContext("2d"),o=1;1==e.thickness?o=1:3==e.thickness?o=2:5==e.thickness&&(o=3);var r=o*this.canvas.width/200;e.draw.length;for(i in e.draw){var n=e.draw[i].x*t.width,s=e.draw[i].y*t.height;if(a.save(),a.beginPath(),a.arc(n,s,r,0,2*Math.PI),a.clip(),a.clearRect(0,0,t.width,t.height),a.restore(),1<=i){var l=e.draw[i-1].x*t.width,c=e.draw[i-1].y*t.height,d=r*Math.sin(Math.atan((s-c)/(n-l))),u=r*Math.cos(Math.atan((s-c)/(n-l))),p=l+d,h=c-u,m=l-d,f=c+u,g=n+d,v=s-u,y=n-d,w=s+u;a.save(),a.beginPath(),a.moveTo(p,h),a.lineTo(g,v),a.lineTo(y,w),a.lineTo(m,f),a.closePath(),a.clip(),a.clearRect(0,0,t.width,t.height),a.restore()}}},drawTxt:function(e){var t=_.getElementById(this.id),a=t.getContext("2d"),i=e.draw.label,o=e.draw.x*t.width,r=e.draw.y*t.height,n=e.draw.size*t.width/this.tp_w;a.font=n+"pt SimSun",a.fillStyle=C(e.color),a.textBaseline="top",a.textAlign="left";var s=i.split("\n");P.each(s,function(e,t){var i=1.9*n;a.fillText(t,o,r+i*e)})},ResetZoom:function(e){if("narrow"===e).2<this.zoom&&(this.zoom=Number((this.zoom-.2).toFixed(2)));else if("enlarge"===e)this.zoom<2&&(this.zoom=Number((this.zoom+.2).toFixed(2)));else if("WhiteBorad"===e||"reset"===e)this.zoom=1;else if("dereset"===e){var t=this,i=P("#"+t.id),a=P("#draw-box").width(),o=P("#draw-box").height();if("WhiteBorad"===u.name)DP.reInit();else{if(0===d)a/o<=t.imgmess.width/t.imgmess.height?(t.dtw=a,t.dth=parseInt(t.imgmess.height*t.dtw/t.imgmess.width)):(t.dth=o,t.dtw=parseInt(t.imgmess.width*t.dth/t.imgmess.height));else t.dtw=a-20,t.dth=parseInt(t.imgmess.height*t.dtw/t.imgmess.width);i.attr({width:t.dtw*this.zoom,height:t.dth*this.zoom}),P("#draw").css({width:t.dtw*this.zoom+"px",height:t.dth*this.zoom+"px"})}t.setMargin()}var r={action:"scale",data:{percent:this.zoom}};S.emit("flipMessage",r)},setMargin:function(){var e=_.getElementById(this.id);e.height<P("#draw-box").height()?P("#draw").css("margin-top",(P("#draw-box").height()-e.height)/2+"px"):P("#draw").css("margin-top","0")},scale:function(e){var t=this,i=P("#"+t.id);t.ResetZoom(e),i.attr({width:t.dtw*this.zoom,height:t.dth*this.zoom}),P("#draw").css({width:t.dtw*this.zoom+"px",height:t.dth*this.zoom+"px"}),t.setMargin()},draw:function(e,t){if("string"==typeof e&&(e=JSON.parse(e)),e){var i=e.docid+"_"+e.page,a=this;if(a.caches[i]||(a.caches[i]={doc:{id:e.docid,num:e.page},draws:[]}),t||a.caches[i].draws.push(e),e.type!=w)if(8!=e.type){var o=a.caches[a.currentDocKey];if(o&&o.doc.id==e.docid&&o.doc.num==e.page)switch(12!=e.type&&(this.DOMfluorescence.style.display="none"),e.type){case n:this.clearScreen(e);break;case h:this.clearPrev(e);break;case m:this.drawLine(e);break;case f:this.drawRect(e);break;case g:this.drawArc(e);break;case v:this.drawTxt(e);break;case y:this.deleteDoc(e);break;case w:this.clearDocDraws(e);break;case b:this.clearERASURE(e);break;case k:this.straightLine(e);break;case x:this.fluorescence(e);break;case D:this.laserPen(e);break;default:throw new Error("unknow draw type")}}else this.clearDocDraws(e);else this.clearDocDraws(e)}}};var N={drawChange:function(e,t){switch(t.action){case"type":0!==T.type&&9!==T.type&&(T.preType=T.type),T.type=t.value,5!==T.type&&P("#drag_input").remove(),9===T.type?p.clearPrev():0===T.type&&p.sendClear();break;case"color":T.color=t.value;break;case"thickNess":T.thickness=t.value;break;case"size":T.fontSize=t.value;break;case"useDraw":p.allow_draw=t.value}},docChange:function(e,t){var i=t.data;switch(t.action){case"pre":0!==parseInt(u.mode)?0==u.animation_count?u.prePage():0<u.animation_count&&(0==u.current_animation?u.prePage():(u.current_animation=0,u.do_animation())):u.prePage();break;case"next":0!==parseInt(u.mode)?u.animation_count===u.current_animation?u.nextPage():(u.current_animation++,u.do_animation()):u.nextPage();break;case"skip":i.toPage&&u.slideTo(i.toPage);break;case"changeDoc":T.name=u.name=i.name,T.docid=u.id=i.id;var a={action:"changeDoc",data:{id:u.id}};if("WhiteBorad"!==i.name){u.totalpage=i.totalpage,T.page=u.currentPage=0,u.docFromRoomId=i.docFromRoomId,u.mode=T.mode=i.mode,u.useSDK=T.useSDK=!!i.useSDK,a.data.urlArr=[];for(var o=0;o<u.totalpage;o++){var r=u.domain+"/image/"+u.docFromRoomId+"/"+u.id+"/"+o+".jpg";a.data.urlArr.push(r)}}else u.mode=T.mode=0,u.useSDK=T.useSDK=!1,u.relativePage=1,T.page=u.currentPage=u.whiteArr[u.relativePage-1],a.data.totalPage=u.totalpage=u.whiteArr.length;S.emit("flipMessage",a),u.slideTo(1);break;case"full":P("#"+l).css("position","fixed"),DP.ResetZoom("dereset");break;case"exitFull":P("#"+l).css("position","relative"),DP.ResetZoom("dereset");break;case"enlarge":DP.scale("enlarge");break;case"narrow":DP.scale("narrow");break;case"resize":DP.ResetZoom("dereset");break;case"addBoard":u.name="WhiteBorad",u.id="WhiteBorad",u.whiteNum=u.whiteNum+1,u.whiteArr.push(u.whiteNum),u.currentPage=u.whiteNum,u.totalpage=u.relativePage=u.whiteArr.length,c&&O.setBoard();a={action:"changeDoc",data:{id:u.id,totalPage:u.totalpage}};S.emit("flipMessage",a),u.flip();break;case"deleteBoard":var n=i.page;if(1<u.whiteArr.length){u.whiteArr.splice(n-1,1);var s=u.whiteArr.indexOf(u.currentPage);-1===s?(1<u.relativePage&&(u.relativePage=u.relativePage-1),u.currentPage=u.whiteArr[u.relativePage-1]):u.relativePage=s+1,u.totalpage=u.whiteArr.length;a={action:"changeDoc",data:{id:u.id,totalPage:u.totalpage}};S.emit("flipMessage",a),u.flip(),c&&O.setBoard()}}}};function C(e){for(var t=parseInt(e,10).toString(16).toUpperCase(),i=t.length,a=0;a<6-i;a++)t="0"+t;return"#"+t}function I(e){return"#"===e.url&&"WhiteBorad"===e.docName}var O={deleteNum:"",setCookie:function(e,t,i){var a=new Date,o=i;a.setTime(a.getTime()+24*o*3600*1e3),_.cookie=e+"="+t+";expires="+a.toGMTString()+"; path=/"},getCookie:function(e){for(var t,i=_.cookie.replace(/[ ]/g,"").split(";"),a=0;a<i.length;a++){var o=i[a].split("=");if(e===o[0]){t=o[1];break}}return t},delete:function(e){var t=new Date;t.setTime(t.getTime()-1e4),_.cookie=e+"=v; expires ="+t.toGMTString()+"; path=/"},setBoard:function(){var e=S.roomid+c,t={arr:u.whiteArr,num:u.whiteNum},i=JSON.stringify(t);O.setCookie(e,i,1)},getBoard:function(){var e=S.roomid+c,t=O.getCookie(e);if(t){var i=JSON.parse(t);u.whiteNum=i.num,u.whiteArr=i.arr}},deleteBoard:function(e){var t='<div class="out-box-2"><div class="inner"><h3><i class="fa icon-guanbipsd"></i></h3><p>'+e+'</p><p class="tips nothing">  </p><div><input type="button" class="cancel" value="'+P.i18n.prop("取消")+'"><input type="button" class="sure-delete" value="'+P.i18n.prop("确定")+'"></div></div><div class="mask"></div></div>';P("body").append(t)}};s.addEventListener("message",function(e){var t=e.data;"string"==typeof t&&(t=JSON.parse(t)),t&&"animation_change_from_dp"===t.action&&(u.animation_count=t.totalSteps-1)}),s.DocumentUpload=e,s.currentDoc=u}(window,document,jQuery);